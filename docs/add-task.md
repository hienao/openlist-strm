# 添加转换任务

转换任务是 OpenList to Stream 的核心功能，用于将 OpenList 中的文件列表转换为 STRM 流媒体文件。本页详细介绍如何创建和管理转换任务。

## 什么是转换任务？

转换任务定义了如何将 OpenList 中的特定路径转换为 STRM 文件：

- 指定要转换的 OpenList 路径
- 设置 STRM 文件的输出位置
- 配置转换选项（更新模式、刮削等）
- 设置定时执行计划

## 创建新任务

### 前置条件

在创建任务之前，请确保：
- ✅ 已添加至少一个 [OpenList 配置](./add-openlist.md)
- ✅ 已准备好 STRM 文件的输出目录

### 第一步：访问任务页面

1. 登录系统
2. 点击顶部导航栏的 **"任务管理"**
3. 点击 **"添加任务"** 按钮

### 第二步：基本信息

#### 任务名称
给任务起一个描述性的名字，例如：
- `电影库转换`
- `电视剧同步`
- `纪录片更新`

#### 选择 OpenList 配置
从下拉列表中选择要使用的 OpenList 服务器配置。
选择后，系统会自动加载该服务器的可用路径。

### 第三步：路径配置

#### OpenList 路径
选择要转换的 OpenList 路径：

**路径示例：**
- `/电影` - 电影目录
- `/电视剧` - 电视剧目录
- `/纪录片` - 纪录片目录

::: tip 路径选择
- 选择父目录可以包含所有子目录的内容
- 路径路径可以实现更精细的转换控制
- 建议按媒体类型（电影、电视剧）分别创建任务
:::

#### STRM 输出路径
设置 STRM 文件的保存路径：

**路径格式：**
- 绝对路径：`/media/movies`（容器内路径）
- 相对路径：`./strm/movies`（相对于挂载目录）

::: warning 路径权限
确保输出目录有足够的写入权限，并且与您的媒体服务器配置一致。
:::

### 第四步：转换设置

#### 更新模式
选择文件的更新策略：

**增量更新（推荐）**
- 只处理新增或修改的文件
- 执行速度快，资源占用少
- 适合定时执行

**全量更新**
- 重新处理所有文件
- 确保完整性，但耗时较长
- 适合首次执行或故障恢复

#### 文件覆盖设置
- ✅ **覆盖现有文件**：更新已存在的 STRM 文件
- ❌ **跳过现有文件**：保留已存在的 STRM 文件

### 第五步：刮削设置

#### 启用 AI 刮削
如果需要自动获取媒体信息，可以启用 AI 刮削：

**刮削内容：**
- 📽️ 电影信息（标题、年份、简介、海报）
- 📺 电视剧信息（季、集、演员、封面）
- 🎭 演员信息和作品列表
- 🏷️ 类型标签和评分

**数据源：**
- TMDB（The Movie Database）
- TVDB（The TV Database）
- OpenList 已有的元数据

::: tip 刮削建议
- 启用刮削可以提供更丰富的媒体信息
- 会消耗一定的 API 调用次数
- 可以在系统设置中配置 API 密钥
:::

#### 刮削选项
- **优先使用 OpenList 元数据**：如果 OpenList 中已有信息，优先使用
- **覆盖现有元数据**：使用新的刮削数据覆盖现有信息
- **下载海报和封面**：自动下载媒体封面图片

### 第六步：定时设置

#### Cron 表达式
设置任务的自动执行时间：

**常用表达式：**
| 表达式 | 说明 |
|--------|------|
| `0 2 * * *` | 每天凌晨2点 |
| `0 */6 * * *` | 每6小时 |
| `0 0 * * 0` | 每周日午夜 |
| `0 0 1 * *` | 每月1号午夜 |
| `0 0 * * 1-5` | 工作日午夜 |

**表达式格式：**
```
分 时 日 月 周
*  *  *  *  *
```

::: tip Cron 工具
可以使用在线 Cron 生成工具来创建复杂的定时表达式。
:::

#### 手动执行
如果不设置定时任务，可以手动执行：
- 立即执行：点击 **"立即执行"** 按钮
- 定期执行：根据需要手动触发

### 第七步：保存和测试

#### 测试路径
点击 **"测试路径"** 按钮：
- ✅ 验证 OpenList 路径是否可访问
- ✅ 检查输出目录是否可写入
- ✅ 显示路径中的文件数量

#### 保存任务
所有配置完成后，点击 **"保存"** 按钮创建任务。

## 管理现有任务

### 任务列表
在任务管理页面可以看到所有任务的状态：

| 任务名称 | OpenList 配置 | 状态 | 最后执行 | 下次执行 | 操作 |
|----------|---------------|------|----------|----------|------|
| 电影库转换 | 家庭媒体服务器 | ✅ 运行中 | 2024-01-15 02:00 | 2024-01-16 02:00 | 执行/编辑/删除 |
| 电视剧同步 | 家庭媒体服务器 | ⏸️ 已暂停 | 2024-01-14 20:00 | - | 启动/编辑/删除 |

### 执行任务

#### 手动执行
1. 在任务列表中找到要执行的任务
2. 点击 **"立即执行"** 按钮
3. 确认执行操作

#### 查看执行状态
- **等待中**：任务已加入执行队列
- **执行中**：正在处理文件
- **已完成**：任务执行完成
- **失败**：执行过程中出现错误

### 编辑任务
1. 在任务列表中找到要编辑的任务
2. 点击 **"编辑"** 按钮
3. 修改配置信息
4. 点击 **"保存"** 确认修改

### 暂停/启动任务
1. 在任务列表中找到要管理的任务
2. 点击 **"暂停"** 或 **"启动"** 按钮
3. 暂停的任务不会自动执行，但仍可手动执行

### 删除任务
1. 在任务列表中找到要删除的任务
2. 点击 **"删除"** 按钮
3. 在确认对话框中点击 **"确认删除"**

::: danger 删除警告
删除任务不会删除已生成的 STRM 文件，但会停止所有未来的自动执行。
:::

## 任务执行详情

### 执行日志
每个任务执行都会生成详细的日志：

**日志信息包括：**
- 开始和结束时间
- 处理的文件数量
- 成功/失败统计
- 错误信息和堆栈跟踪
- 刮削结果统计

### 性能统计
- **处理速度**：文件/秒
- **网络请求**：API 调用次数
- **资源占用**：CPU 和内存使用情况
- **执行时长**：总耗时

## 高级配置

### 并发控制
在系统设置中可以配置：
- 最大并发任务数
- 单任务最大文件处理数
- 网络请求超时时间

### 错误处理
- **失败重试**：自动重试失败的文件
- **跳过错误**：继续处理其他文件
- **停止执行**：遇到错误时停止整个任务

### 通知设置
- **执行完成通知**：任务完成后发送通知
- **错误通知**：执行失败时发送告警
- **邮件通知**：通过邮件发送执行报告

## 常见问题

### Q: 任务执行很慢怎么办？
A: 可以尝试以下优化：
- 启用增量更新模式
- 减少并发任务数
- 检查网络连接质量
- 考虑分批处理大量文件

### Q: 如何处理大量文件？
A: 建议采用以下策略：
- 按媒体类型分别创建任务
- 使用增量更新模式
- 设置合适的执行时间（避开高峰期）
- 监控系统资源使用情况

### Q: STRM 文件无法播放？
A: 检查以下几点：
- 确认 STRM 文件路径正确
- 检查媒体服务器配置
- 验证原始文件是否可访问
- 查看任务执行日志

## 最佳实践

### 1. 任务规划
- 按媒体类型（电影、电视剧、纪录片）分别创建任务
- 使用描述性的任务名称
- 设置合理的执行时间

### 2. 路径管理
- 保持 OpenList 路径和输出路径的一致性
- 使用绝对路径避免路径混淆
- 定期清理无用的任务和文件

### 3. 性能优化
- 优先使用增量更新
- 合理设置并发数量
- 监控系统资源使用

### 4. 监控和维护
- 定期查看执行日志
- 设置错误通知
- 及时处理失败的任务

---

现在您已经掌握了任务管理的全部内容，可以开始创建您的第一个转换任务了！如果遇到问题，可以查看 [常见问题](./faq.md) 或 [系统日志](./log.md)。